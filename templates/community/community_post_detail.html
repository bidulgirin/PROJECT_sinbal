{% extends 'base/base.html' %} {% load static %}
<!-- head title -->
{% block head_name %}이런신발 - 커뮤니티{% endblock %}
<!-- 컨텐츠 -->
{% block content%}
<!-- 상단 헤더 (Bootstrap navbar 컴포넌트) -->
<div class="container mt-4" style="min-height: 100vh">
    <!-- 수정/삭제 버튼 -->
    <!-- 본인글에서만보이게 -->
    {% if data.author_id == user.id %}
    <div class="text-end">
        <a class="btn btn-primary" href="{% url 'community:edit_post' id=data.id %}">수정</a>
        <button type="button" class="btn btn-danger delete_btn">삭제</button>
    </div>
    {% endif %}
    <form method="POST" id="form">{% csrf_token %}</form>

    <!-- 글 상세페이지 -->
    <h1 class="g_title">{{ data.title }}</h1>
    <div class="text-secondary">조회수 : {{data.views}} | 좋아요 수 : {{ data.like_users.count }}</div>
    <hr />
    <div class="g_img_box">
        {% if data.postimage_set.all %}
        <!-- 이미지가 있을경우 -->
        {% for i in data.postimage_set.all %}
        <img src="{{i.images.url}}" alt="{{i.title}}_이미지" />
        {% endfor %} {% endif %}
    </div>
    <div class="mt-4">
        <div class="">{{ data.content|linebreaksbr }}</div>
    </div>
    <div class="l_heart pt-3 pb-3 cursor">
        <form action="{% url 'community:post_like' post_id=data.id %}">
            <div class="flex-fill">
                <button class="heart">
                    <label for="checkbox">
                        <!-- if 너의 찜목록에 shoe_id 가 잇으면? -->
                        {% if user in data.like_users.all %}
                        <input type="checkbox" id="checkbox" hidden checked data-shoe="{{data.id}}" />
                        {% else %}
                        <input type="checkbox" id="checkbox" hidden data-shoe="{{data.id}}" />
                        {% endif %}
                        <svg class="icon" viewBox="0 0 1024 1024">
                            <path
                                d="M742.4 101.12A249.6 249.6 0 0 0 512 256a249.6 249.6 0 0 0-230.72-154.88C143.68 101.12 32 238.4 32 376.32c0 301.44 416 546.56 480 546.56s480-245.12 480-546.56c0-137.92-111.68-275.2-249.6-275.2z"
                                fill="#231F20" class="heart2"></path>
                        </svg>
                    </label>
                    <br>
                    <span class="text-secondary">좋아요!</span>
                </button>
            </div>
        </form>
    </div>
    <div class="g_comment">
        <!-- 댓글 입력창 -->
        <h4 class="fw-bold">댓글입력</h4>
        <form action="{% url 'community:comments_create' id=data.id %}" method="POST">
            {% csrf_token %} {{ form.content }}
            <input type="hidden" name="post" value="{{ data.id }}" />
            <button type="submit" class="btn btn-outline-primary w-100 mt-3">등록</button>
        </form>
        <h5 class="fw-bold pt-3">댓글 목록 ({{ data.comments.all|length }})</h5>
        {% if data.comments.all %}
        <!-- 댓글이 있다면 -->
        {% for i in data.comments.all %}
        <!-- 돌려돌려 돌림판~ -->
        <div class="pt-3 pb-3">
            <div class="l_commment_user">
                <img src="{% static 'img/human.jpg' %}" alt="">
                <div>
                    <span class="fw-bold">{{ i.author.username }}</span><br />
                    <span class="text-secondary">{{ i.author.created_at }}</span>
                </div>
            </div>
            <div class="l_comment_contents">
                <p class="text-secondary">{{ i.content|linebreaksbr }}</p>
                {% if user.id == i.author_id %}
                <form id="comment_delete_form" style="text-align: right">
                    <button class="btn btn-danger comment_delete_btn" data-id="{{i.id}}">삭제</button>
                </form>
                {% endif %}
            </div>

            <!-- 자신의 댓글만 삭제할수있도록 -->

            <hr />
        </div>
        <!--  -->
        {% endfor %}
        <!--  -->
        {% endif %}
    </div>
    <script>
        // 삭제 버튼 누르면 해당 id 값과 action 슥~ 보내기
        const delete_btns = document.querySelector(".delete_btn");
        delete_btns.addEventListener("click", () => {
            const delete_row_id = Number("{{data.id}}");
            if (confirm("글을 삭제하시겠습니까?")) {
                delete_data(delete_row_id);
            }
        });
        function delete_data(id) {
            const form = document.querySelector("#form");
            form.action = `/community/post/delete/${id}/`;
            form.method = "GET";
            form.submit();
        }

        // 댓글 삭제 버튼

        // 삭제 버튼 누르면 해당 id 값과 action 슥~ 보내기
        const comment_delete_btns = document.querySelectorAll(".comment_delete_btn");
        comment_delete_btns.forEach((e) => {
            e.addEventListener("click", () => {
                const delete_row_id = e.getAttribute("data-id");
                if (confirm("댓글을 삭제하시겠습니까?")) {
                    delete_comment_data(delete_row_id);
                }
            });
        });
        // 함수가 작동할때만 form 의 내용을 변경해주는 방식을 사용합니다.
        function delete_comment_data(id) {
            const form = document.querySelector("#comment_delete_form");
            form.action = `/community/post_detail/${id}/comment_remove/`;
            form.method = "GET";
            form.submit();
        }
    </script>
    <style>
        .heart {
            padding: .5rem;
            box-sizing: border-box;
            height: auto;
            text-align: center;
            border: 0;
            display: block;
            background-color: #00000000;
        }

        .l_commment_user {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .l_comment_contents {
            align-items: center;
            display: flex;
            gap: 10px;
        }

        .l_comment_contents p {
            background-color: white;
            border-radius: 10px;
            padding: 20px 10px;
            margin-top: 10px;
            border: 1px solid #dcdcdc;
            flex: 1;
        }

        .l_commment_user img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            border: 1px solid #dcdcdc;
        }
    </style>

    {% endblock %}
</div>