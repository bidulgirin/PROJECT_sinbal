<!--  -->
{% load static %}
<!-- 콤마를위함 -->
{% load humanize %}
<!-- 콘텐츠 영역 -->
<form method="POST" action="{% url 'cart' %}" id="cart_form">
    {% csrf_token %}
    <div class="row l_cart_content_by_mypage">
        <div class="col pt-3 pb-3">
            <h4 class="fw-bold">장바구니 목록</h4>
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col" width="5%">
                            <input type="checkbox" id="all_check" />
                        </th>
                        <th scope="col" width="10%">상품</th>
                        <th scope="col" width="35%">상품이름</th>
                        <th scope="col" width="15%">가격</th>
                        <th scope="col" width="10%">사이즈</th>
                        <th scope="col" width="10%">수량</th>
                        <th scope="col" width="20%">삭제</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in cart_datas %}
                    <tr>
                        <td class="align-middle">
                            <input type="checkbox" name="shoe_id[]" id="{{data.shoe.id}}" value="{{data.id}}"
                                data-price="{{data.shoe.price}}" data-count="{{data.quantity}}" />
                        </td>
                        <td class="align-middle">
                            {% if data.shoe.images %}
                            <img src="{{data.shoe.images.url}}" alt="{{data.shoe.name}}" width="60px" heihgt="60px" />
                            {% else %}
                            <img src="{% static 'img/no_img.png' %}" width="60px" heihgt="60px" />
                            {% endif %}
                        </td>

                        <td class="align-middle">{{data.shoe.name}}</td>
                        <td class="align-middle">{{data.shoe.price|intcomma}}원</td>
                        <td class="text-center align-middle">{{data.size}}</td>
                        <td class="text-center align-middle">{{data.quantity}}</td>
                        <td class="align-middle">
                            <button class="btn btn-danger delete_btn" type="button" data-id="{{data.id}}">
                                삭제
                            </button>
                        </td>
                    </tr>

                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center align-middle">장바구니가 텅 비었습니다</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col p-3">
            <h4 class="fw-bold">최종 결제 금액</h4>
            <table class="table">
                <tr>
                    <td width="100px">총 가격</td>
                    <td class="align-middle">
                        <span id="total_price_dom">0</span>
                        원
                    </td>
                </tr>
                <tr>
                    <td width="100px">배송비</td>
                    <td class="align-middle">0 원</td>
                </tr>
            </table>
            <button id="cart_submit_btn" class="btn btn-primary w-100" type="submit">구매하기</button>
        </div>
    </div>
</form>
<script>
    // all_check 체크하면 모두 체크 아니면 모두 체크 아님

    const all_check = document.querySelector("#all_check");
    let checkboxs = document.getElementsByName("shoe_id[]");

    function checkbox_all_check() {
        if (checkboxs.length > 0) {
            checkboxs.forEach((e) => {
                e.checked = true;
            });
            if (all_check.checked == false) {
                checkboxs.forEach((e) => {
                    e.checked = false;
                });
            }
        }
        calculator();
        cart_submit_btn_check();
    }
    all_check.addEventListener("click", checkbox_all_check);

    // 체크한 상품 총 가격 계산하기 ( jquery code )
    let totalCost = 0;

    $(function () {
        $("#total").text(totalCost);
    });

    $("input[name='shoe_id[]']").change(function () {
        calculator();
        cart_submit_btn_check();
    });
    function comma(str) {
        str = String(str);
        return str.replace(/(\d)(?=(?:\d{3})+(?!\d))/g, "$1,");
    }
    // 계산해줌
    function calculator() {
        totalCost = 0;
        $("#total_price_dom").text(totalCost);
        $("tbody input:checked").each(function () {
            totalCost += parseInt($(this).attr("data-price")) * parseInt($(this).attr("data-count"));
            $("#total_price_dom").text(comma(totalCost));
        });
    }

    // 삭제 버튼 누르면 해당 id 값과 action 슥~ 보내기
    const delete_btns = document.querySelectorAll(".delete_btn");
    delete_btns.forEach((e) => {
        e.addEventListener("click", () => {
            const delete_row_id = e.getAttribute("data-id");
            if (confirm("장바구니에서 삭제하시겠습니까?")) {
                delete_cart_data(delete_row_id);
            }
        });
    });
    // 함수가 작동할때만 form 의 내용을 변경해주는 방식을 사용합니다.
    function delete_cart_data(id) {
        const form = document.querySelector("#cart_form");
        form.action = `/mall/cart/remove/${id}/`;
        form.method = "GET";
        form.submit();
    }
    // 기본 값 모두 체크
    $("#all_check").trigger("click");

    // totalCost 가 0 이면 구매하기 버튼 비활성화
    function cart_submit_btn_check() {
        console.log("!!!!!!!");
        console.log(totalCost);
        const cart_submit_btn = document.querySelector("#cart_submit_btn");
        if (totalCost == 0) {
            cart_submit_btn.disabled = true;
            console.log("disabled");
        } else {
            cart_submit_btn.disabled = false;
            console.log("no");
        }
    }
</script>