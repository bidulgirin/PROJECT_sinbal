<!-- 구매 완료 페이지 -->
{% extends 'base/base.html' %} {% load static %}
<!-- 콤마를위함 -->
{% load humanize %} {% block content %}
<!-- 콘텐츠 영역 -->
<div class="container p-3">
    <form method="POST" action="">
        {% csrf_token %}
        <div class="row">
            <div class="col">
                {% include 'mall/components/user_info.html' %}
                <h4 class="fw-bold">구매하는 상품 목록</h4>
                <table class="table">
                    <tr>
                        <th scope="col">상품</th>
                        <th scope="col">상품이름</th>
                        <th scope="col">가격</th>
                        <th scope="col">사이즈</th>
                        <th scope="col">수량</th>
                    </tr>
                    <tr>
                        <td>
                            <!-- 카트아이디 -->
                            <input type="text" name="cart_id[]" value="0" hidden />
                            <input type="text" name="shoe_id[]" value="{{data.id}}" hidden />
                            <input type="text" name="shoe_name[]" value="{{data.name}}" hidden />
                            <input type="text" name="price[]" value="{{data.price}}" hidden />
                            <input type="text" name="shoe_size[]" value="{{size}}" hidden />
                            <input type="text" name="quantity[]" value="{{quantity}}" hidden />
                            {% if data.images %}
                            <img src="{{data.images.url}}" alt="{{data.name}}" width="60px" heihgt="60px" />
                            {% else %}
                            <img src="{% static 'img/no_img.png' %}" alt="{{data.name}}" width="60px" heihgt="60px" />

                            {% endif %}
                        </td>

                        <td>{{data.name}}</td>
                        <td>{{data.price|intcomma}}</td>
                        <td>{{size}}</td>
                        <td>{{quantity}}</td>
                    </tr>
                </table>
            </div>
            <div class="col p-3">
                <h4 class="fw-bold">최종 결제 금액</h4>
                <table class="table">
                    <tr>
                        <td>총 가격</td>
                        <td>
                            <input id="total_price" name="total_price" type="text" hidden />
                            <p id="total_price_p"></p>
                        </td>
                    </tr>
                    <tr>
                        <td>배송비</td>
                        <td>0 원</td>
                    </tr>
                </table>
                <!-- 결제하기 누르기 전에 
                    1. 배송지를 입력하였는지
                    2. 결제수단을 입력하였는지 확인하는 js 코드 필요
                    3. 모두 입력했으면 결제하기 버튼 활성화시키기
                -->
                <button class="btn btn-primary" type="submit">결제하기</button>
            </div>
        </div>
    </form>
</div>
<!-- 주소 api -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    function DaumPostcode() {
        new daum.Postcode({
            oncomplete: function (data) {
                var addr = ""; // 주소 변수
                var extraAddr = ""; // 참고항목 변수

                //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                if (data.userSelectedType === "R") {
                    // 사용자가 도로명 주소를 선택했을 경우
                    addr = data.roadAddress;
                } else {
                    // 사용자가 지번 주소를 선택했을 경우(J)
                    addr = data.jibunAddress;
                }

                // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
                if (data.userSelectedType === "R") {
                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if (data.bname !== "" && /[동|로|가]$/g.test(data.bname)) {
                        extraAddr += data.bname;
                    }
                    // 건물명이 있고, 공동주택일 경우 추가한다.
                    if (data.buildingName !== "" && data.apartment === "Y") {
                        extraAddr += extraAddr !== "" ? ", " + data.buildingName : data.buildingName;
                    }
                    // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                    if (extraAddr !== "") {
                        extraAddr = " (" + extraAddr + ")";
                    }
                    // 조합된 참고항목을 해당 필드에 넣는다.
                    // document.getElementById("sample6_extraAddress").value =
                    //     extraAddr;
                } else {
                    // document.getElementById("sample6_extraAddress").value = "";
                }

                // 우편번호와 주소 정보를 해당 필드에 넣는다.
                document.getElementById("postcode").value = data.zonecode;
                document.getElementById("address").value = addr;
                // 커서를 상세주소 필드로 이동한다.
                document.getElementById("detailAddress").focus();
            },
        }).open();
    }

    // total_price //구하기
    // price[] 으로 된 value 를 모두 더하기
    let total_price = 0;
    let price_input = document.getElementsByName("price[]");
    let quantity_input = document.getElementsByName("quantity[]");

    price_input.forEach((e, idx) => {
        let price_value = Number(e.value);
        let quantity_value = Number(quantity_input[idx].value);
        total_price += price_value * quantity_value; // 값 * 개수
        // 나온값 모두 더하기
    });
    // 나온값 form input 입력
    const total_price_input = document.querySelector("#total_price");
    const total_price_p = document.querySelector("#total_price_p");
    total_price_input.value = total_price;
    // html 에도 입력
    total_price_p.innerText += `${addComma(total_price)} 원`;

    // 체크 박스 하나만

    function checkOnlyOne(element) {
        const checkboxes = document.getElementsByName("pay_method");

        checkboxes.forEach((cb) => {
            cb.checked = false;
        });

        element.checked = true;
    }
    // 전화번호 포멧
    function addHyphenToPhoneNumber(phoneNumberInput) {
        const phoneNumber = phoneNumberInput.value;
        const length = phoneNumber.length;

        if (length >= 9) {
            let numbers = phoneNumber.replace(/[^0-9]/g, "").replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`);
            phoneNumberInput.value = numbers;
        }
    }

    const phoneInput = document.getElementById("phone");
    phoneInput.addEventListener("input", () => {
        addHyphenToPhoneNumber(phoneInput);
    });

    // 콤마 포멧
    function addComma(num) {
        let len, point, str;

        num = num + "";
        point = num.length % 3;
        len = num.length;

        str = num.substring(0, point);
        while (point < len) {
            if (str != "") str += ",";
            str += num.substring(point, point + 3);
            point += 3;
        }

        return str;
    }
</script>
{% endblock %}